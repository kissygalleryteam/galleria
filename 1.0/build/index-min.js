/*! galleria - v1.0 - 2013-06-26 6:04:21 PM
* Copyright (c) 2013 bachi; Licensed  */
KISSY.add("gallery/galleria/1.0/fsm",function(t){function e(t){this.config=t,this.currentState=this.config.initState,this.nextState=null,this.states=this.config.states,this.events=this.config.events,this.defineEvents()}t.DOM,t.Event;var i={handleEvents:function(t){if(this.currentState){var e=this.states[this.currentState][t.type];if(e){var i=e.call(this,t);this.currentState=i}}},doTransition:function(t,e,i){var s=this.states[t][e];if(s){var n=s.call(this,i);this.currentState=n}},defineEvents:function(){var e=this,i=this.events;t.each(i,function(t,i){t.call(e,function(t){e.fire(i,t)}),e.on(i,e.handleEvents)})}};return t.augment(e,t.EventTarget,i),t.FSM=e,e},{requires:["core"]}),KISSY.add("gallery/galleria/1.0/index",function(t){"use strict";function e(t,e){if(1==e){var i=t.shift();t.push(i)}else{var i=t.pop();t.unshift(i)}return t}function i(e,i){var o=this;o.data=[],o.activeIndex=0,o.showing=!1,o.cfg=t.mix({index:0,itemCls:"ss-picitem"},i),o.activeIndex=0,o.listItem=s.query("."+o.cfg.itemCls,e),o.container=s.create('<div class="ss-container" style="display:none"></div>'),o.closeBtn=s.create('<a href="#" class="ss-close-btn" title="关闭"></a>'),o.showItem=[],t.each(a,function(){var t=s.create('<div class="ss-show-item"></div>');o.showItem.push(t),s.append(t,o.container),n.on(t,"mouseenter",function(t){var e=t.currentTarget;s.hasClass(e,"ss-small-pic")&&s.addClass(e,"ss-hover")}),n.on(t,"mouseleave",function(t){var e=t.currentTarget;s.hasClass(e,"ss-small-pic")&&s.removeClass(e,"ss-hover")})}),o.mask=s.create('<div class="ss-mask"></div>'),s.append(o.mask,o.container),s.append(o.closeBtn,o.container),s.append(o.container,"body"),o.pos={width:0,height:0,top:0,left:0},o.globalTimeout=null,o.flags={isShow:!1,isAnim:!1},o.pushData();var c={initState:"hidden",states:{hidden:{clickpic:function(t){return o.showView(t),"view"}},view:{close:function(){return o.closeView(),"hidden"},next:function(){return o.showNext(),"view"},prev:function(){return o.showPrev(),"view"},resize:function(){return o.resizeView(),"view"}}},events:{clickpic:function(t){n.on(o.listItem,"click",function(e){e.halt(),e.curItem=e.currentTarget,t(e)})},close:function(t){n.on(o.closeBtn,"click",function(e){e.halt(),t()}),n.on(o.mask,"click",function(e){e.target==this&&t()}),n.on(document,"keydown",function(e){var i=e.keyCode;switch(i){case 39:e.halt(),o.activeIndex==o.data.length-1&&t();break;case 37:e.halt(),0==o.activeIndex&&t();break;case 27:e.halt(),t();break;default:}})},prev:function(t){n.on(o.showItem,"click",function(e){o.flags.isAnim||e.currentTarget==o.showItem[1]&&(e.halt(),t(e))}),n.on(document,"keydown",function(e){if(!o.flags.isAnim){var i=e.keyCode;switch(i){case 37:e.halt(),t();break;default:}}})},next:function(t){n.on(o.showItem,"click",function(e){o.flags.isAnim||(e.currentTarget==o.showItem[3]||e.currentTarget==o.showItem[2])&&(e.halt(),t(e))}),n.on(document,"keydown",function(e){if(!o.flags.isAnim){var i=e.keyCode;switch(i){case 39:e.halt(),t();break;default:}}})},resize:function(t){n.on(window,"resize",function(){t()})}}};o.FSM=new t.FSM(c)}var s=t.DOM,n=t.Event,a=["ss-before-prev","ss-prev","ss-main","ss-next","ss-after-next"];return t.augment(i,t.EventTarget,{disable:function(t){var e=this;e.flags.isAnim=!0,setTimeout(function(){e.flags.isAnim=!1},1e3*t)},showView:function(e){var i=this,n=e.curItem,a=s.attr(n,"data-index"),o=6==t.UA.ie?!1:!0;s.addClass("html","ss-hideoverflow"),i.activeIndex=parseInt(a),i.buildShowView(),t.one(i.closeBtn).hide(),t.each(i.showItem,function(e){t.one(e).hide()}),i.setpos(i.getItemPos(n),i.getWinPos(),o,!0,function(){i.disable(.5),t.one(i.closeBtn).fadeIn(.04),t.each(i.showItem,function(e){t.one(e).fadeIn(.2)})})},closeView:function(){var e=this,i=e.activeIndex,n=e.listItem[i],a=s.offset(n).top;t.one(e.closeBtn).hide(),t.each(e.showItem,function(e){t.one(e).hide()}),t.Anim(window,{scrollTop:a-s.viewportHeight()/2},.2,"easeOut").run(),e.setpos(e.getWinPos(),e.getItemPos(n),!0,!1),s.removeClass("html","ss-hideoverflow")},buildShowView:function(e){for(var i=this,n=i.activeIndex-0,a=i.data,o=i.showItem,c=[],r=n-2;n+2>=r;r++)s.attr(o[r-n+2],"data-index",r),r>=0&&a.length>r?c.push(a[r]):c.push({orgin:"",big:"",small:""});t.each(c,function(t,i){var n=new Image,a=new Image,c=s.get("img",o[i]);n.src=t.small,a.src=t.big,(-1!=e||0==i||2==i)&&(1!=e||4==i||2==i)&&(2!=i?(o[i].innerHTML="<b></b>",s.append(n,o[i])):c?c.src=t.big:(o[i].innerHTML="<b></b>",s.append(a,o[i])))});var h;-1==e&&(h=0),1==e&&(h=4),i.setPicPos(h)},resizeView:function(){var t=this;t.setpos(t.pos,t.getWinPos(),!1,!0),t.setPicPos()},getItemPos:function(t){var e=s.offset(t).top,i=s.offset(t).left,n=s.outerWidth(t),a=s.outerHeight(t);return{top:e,left:i,width:n,height:a}},getWinPos:function(){var t=s.scrollTop(),e=0,i=s.viewportWidth(),n=s.viewportHeight();return{top:t,left:e,width:i,height:n}},setpos:function(e,i,n,a,o){var c=this,r=a?.6:1,h=a?1:.6;if(r=s.css(c.container,"opacity")||r,s.css(c.container,{width:e.width+"px",height:e.height+"px",top:e.top+"px",left:e.left+"px",opacity:s.css(c.container,"opacity")||r}),a&&s.show(c.container),c.pos=i,n){c.flags.isAnim=!0;var l=new t.Anim(c.container,{width:i.width+"px",height:i.height+"px",top:i.top+"px",left:i.left+"px",opacity:h},.3,"easeOut",function(){c.flags.isAnim=!1,a||s.hide(c.container),o&&o()});l.run()}else s.css(c.container,{width:i.width+"px",height:i.height+"px",top:i.top+"px",left:i.left+"px",opacity:h}),o&&o()},pushData:function(){var e=this,i=e.listItem;t.each(i,function(t,i){var a=s.get("img",t),o=a.src.replace(/_[0-9]{1,3}x[0-9]{1,3}\.jpg/,""),c=a.src.replace(/_[0-9]{1,3}x[0-9]{1,3}\.jpg/,""),r=a.src.replace(/_[0-9]{1,3}x[0-9]{1,3}\.jpg/,"_250x250.jpg"),h={origin:o,big:c,small:r};s.attr(t,"data-index",i),e.data.push(h),a=new Image,a.src=o,a.width>0?h.scale=a.width/a.height:n.on(a,"load",function(){n.remove(a,"load",arguments.callee),h.scale=a.width/a.height})})},setSmallPic:function(e,i){function a(e){var n=e.width/e.height,a=o.showItem[0],c=s.outerWidth(a),r=s.outerHeight(a),h=Math.max(c,r*n),l=Math.max(r,c/n),u=(c-h)/2,d=(r-l)/2;return i||(s.css(e,{width:h+"px",height:l+"px",left:u+"px",top:d+"px"}),t.one(e).fadeIn()),{width:h+"px",height:l+"px",left:u+"px",top:d+"px"}}var o=this,c=s.get("img",e);return c.width?a(c,e):(s.hide(c),n.on(c,"load",function(){return n.remove(c,"load",arguments.callee),a(c,e)}),void 0)},getMainSize:function(t){t=parseInt(t!==void 0?t:this.activeIndex);var e=this.data[t],i=s.viewportHeight(),n=s.viewportWidth()-200,a=Math.max(n-90,400),o=Math.max(i-200,300),c=Math.min(a,o*e.scale),r=Math.min(o,a/e.scale);return{left:(n-c)/2+100+"px",top:(i-r)/2+"px",width:c+"px",height:r+"px"}},setPicPos:function(){function e(t){var e=s.get("img",t);s.attr(e,"style",""),s.css(e,{width:"100%",height:"100%"})}var i=this,n=i.showItem,a=s.viewportHeight(),o=s.viewportWidth(),c=s.outerHeight(n[0]),r=s.outerWidth(n[0]),h=(a-c)/2;s.show(n),t.each(n,function(t,e){2==e&&(s.removeClass(t,"ss-small-pic"),s.addClass(t,"ss-main-pic")),2!=e&&(s.addClass(t,"ss-small-pic"),s.removeClass(t,"ss-main-pic"),s.removeClass(t,"ss-hover"))}),s.addClass(n,"ss-cursor"),s.css(n[0],{top:h+"px",left:-r+"px"}),i.setSmallPic(n[0]),s.css(n[1],{top:h+"px",left:0}),i.setSmallPic(n[1]),s.css(n[2],i.getMainSize()),e(n[2]),s.removeClass(n[2],"ss-cursor"),s.css(n[3],{top:h+"px",left:o-r+"px"}),i.setSmallPic(n[3]),s.css(n[4],{top:h+"px",left:o+"px"}),i.setSmallPic(n[4]),0==i.activeIndex&&s.hide(n[1]),i.activeIndex==i.data.length-1&&s.hide(n[3])},scrollAnim:function(i){var n,a=this,o=a.showItem,c=[],r=.2;if(!(0>a.activeIndex+i||a.activeIndex+i>=a.data.length)){s.show(o),t.each(o,function(t,e){return 2==e?(n=a.getMainSize(parseInt(s.attr(t,"data-index"))+i),c.push(n),void 0):(c.push({left:s.css(t,"left"),top:s.css(t,"top"),width:s.css(t,"width"),height:s.css(t,"height")}),void 0)});var h={width:n.width,height:n.height,top:0,left:0};s.removeClass(o[2+i],"ss-cursor"),s.addClass(o[2],"ss-cursor"),s.removeClass(o[2],"ss-hover"),s.css(s.get("img",o[2+i]),t.mix(h,{width:"100%",height:"100%"})),t.Anim(s.get("img",o[2]),a.setSmallPic(o[2],!0),r,"easeOut").run(),o=a.showItem=e(o,i),setTimeout(function(){a.activeIndex+=i,a.buildShowView(i),a.flags.isAnim=!1},1500*r),t.each(o,function(e,s){var n=r;(1!=i||4!=s)&&(-1!=i||0!=s)&&(a.flags.isAnim=!0,2!=s&&s!=2-i&&(n=1.5*r),t.Anim(e,c[s],n,"easeOut",function(){}).run())})}},showNext:function(){var t=this;t.scrollAnim(1)},showPrev:function(){var t=this;t.scrollAnim(-1)}}),t.Galleria=i,i},{requires:["core","sizzle","template","switchable","./fsm"]});